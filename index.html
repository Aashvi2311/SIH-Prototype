{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
                <i class="fas fa-shield-alt text-primary me-3"></i>
                Document Verification System
            </h1>
            <p class="lead">Secure verification of educational documents issued by institutions in Jharkhand</p>
        </div>

        <!-- Upload Form -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Upload Document for Verification
                </h3>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h4>Drag & Drop Document Here</h4>
                            <p class="text-muted mb-3">or click to browse files</p>
                            <input type="file" name="certificate" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click();">
                                <i class="fas fa-folder-open me-1"></i>Choose File
                            </button>
                        </div>
                    </div>
                    
                    <div id="selectedFile" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-file me-2"></i>
                            <strong>Selected:</strong> <span id="fileName"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearFile()">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-grid mt-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="verifyBtn" disabled>
                            <i class="fas fa-search me-2"></i>
                            <span id="verifyBtnText">Verify Document</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Verification Result -->
        <div id="verificationResult" class="verification-result" style="display: none;"></div>

        <!-- Information -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                        <h5>Secure Verification</h5>
                        <p class="text-muted">Advanced OCR and pattern matching technology ensures accurate verification of documents.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-2x text-warning mb-3"></i>
                        <h5>Fast Processing</h5>
                        <p class="text-muted">Get instant verification results within seconds of uploading your document.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-university fa-2x text-info mb-3"></i>
                        <h5>Institutional Database</h5>
                        <p class="text-muted">Verification against official records from recognized institutions across Jharkhand.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload handling
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const selectedFileDiv = document.getElementById('selectedFile');
const fileName = document.getElementById('fileName');
const verifyBtn = document.getElementById('verifyBtn');
const uploadForm = document.getElementById('uploadForm');

// Drag and drop functionality
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

uploadArea.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    // Check file type
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    if (!allowedTypes.includes(file.type)) {
        alert('Please select a PDF, JPG, JPEG, or PNG file.');
        return;
    }
    
    // Check file size (16MB max)
    if (file.size > 16 * 1024 * 1024) {
        alert('File size must be less than 16MB.');
        return;
    }
    
    fileName.textContent = file.name;
    selectedFileDiv.style.display = 'block';
    verifyBtn.disabled = false;
}

function clearFile() {
    fileInput.value = '';
    selectedFileDiv.style.display = 'none';
    verifyBtn.disabled = true;
    document.getElementById('verificationResult').style.display = 'none';
}

// Form submission
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('certificate', fileInput.files[0]);
    
    // Update button state
    verifyBtn.disabled = true;
    document.getElementById('verifyBtnText').textContent = 'Verifying...';
    
    // Hide previous results
    document.getElementById('verificationResult').style.display = 'none';
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        displayResult(result);
        
    } catch (error) {
        displayResult({
            status: 'ERROR',
            message: 'Network error occurred. Please try again.'
        });
    } finally {
        // Reset button state
        verifyBtn.disabled = false;
        document.getElementById('verifyBtnText').textContent = 'Verify Document';
    }
});

function displayResult(result) {
    const resultDiv = document.getElementById('verificationResult');
    let statusClass = 'status-' + result.status.toLowerCase();
    let statusIcon = 'fas fa-question-circle';
    let statusText = result.status;
    
    // Determine icon and styling based on status
    switch (result.status) {
        case 'VALID':
            statusIcon = 'fas fa-check-circle';
            statusClass = 'text-success';
            break;
        case 'INVALID':
            statusIcon = 'fas fa-times-circle';
            statusClass = 'text-danger';
            break;
        case 'SUSPICIOUS':
            statusIcon = 'fas fa-exclamation-triangle';
            statusClass = 'text-warning';
            break;
        case 'ERROR':
            statusIcon = 'fas fa-exclamation-circle';
            statusClass = 'text-danger';
            statusText = 'Error';
            break;
    }
    
    let html = `
        <div class="card shadow mt-4">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="${statusIcon} ${statusClass} me-2"></i>
                    Verification Result: <span class="${statusClass}">${statusText}</span>
                </h4>
            </div>
            <div class="card-body">
    `;
    
    if (result.status === 'ERROR') {
        html += `<div class="alert alert-danger">${result.message || result.error}</div>`;
    } else {
        // Display confidence score
        if (result.confidence_score) {
            html += `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Confidence Score:</strong> ${result.confidence_score}%
                        <div class="progress mt-1">
                            <div class="progress-bar ${result.confidence_score > 70 ? 'bg-success' : result.confidence_score > 40 ? 'bg-warning' : 'bg-danger'}" 
                                 style="width: ${result.confidence_score}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Display extracted data
        if (result.extracted_data && Object.keys(result.extracted_data).length > 0) {
            html += `
                <h5>Extracted Information</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
            `;
            
            for (const [key, value] of Object.entries(result.extracted_data)) {
                if (value) {
                    html += `
                        <tr>
                            <td><strong>${key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong></td>
                            <td>${value}</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                    </table>
                </div>
            `;
        }
        
        // Display matched certificate
        if (result.matched_certificate) {
            html += `
                <h5 class="mt-4">Matched Certificate</h5>
                <div class="alert alert-info">
                    <strong>${result.matched_certificate.student_name}</strong><br>
                    <strong>Certificate:</strong> ${result.matched_certificate.certificate_number}<br>
                    <strong>Course:</strong> ${result.matched_certificate.course_name}<br>
                    <strong>Institution:</strong> ${result.matched_certificate.institution_name}<br>
                    <strong>Year:</strong> ${result.matched_certificate.passing_year}<br>
                    <strong>Match Score:</strong> ${result.matched_certificate.match_score}%
                </div>
            `;
        }
        
        // Display flags
        if (result.flags && result.flags.length > 0) {
            html += `
                <h5 class="mt-4">Detection Flags</h5>
                <div class="alert alert-warning">
            `;
            
            result.flags.forEach(flag => {
                html += `<span class="badge bg-warning text-dark me-1">${flag.replace('_', ' ')}</span>`;
            });
            
            html += `</div>`;
        }
    }
    
    html += `
            </div>
        </div>
    `;
    
    resultDiv.innerHTML = html;
    resultDiv.style.display = 'block';
    
    // Scroll to result
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
